name: catbuntu

on:
  workflow_dispatch:

jobs:
  build_iso:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y debootstrap squashfs-tools xorriso isolinux syslinux-utils mtools

      - name: Create minimal rootfs
        run: |
          sudo debootstrap --variant=minbase stable rootfs http://deb.debian.org/debian

      - name: Fix systemd / networking basics
        run: |
          sudo chroot rootfs /bin/bash -c "apt-get update && apt-get install -y --allow-downgrades --allow-remove-essential --fix-broken systemd ifupdown net-tools iproute2 iputils-ping"

      - name: Prepare ISO structure
        run: |
          mkdir -p iso/{boot,live}
          sudo rsync -a rootfs/ iso/live/
          mkdir -p iso/boot/isolinux
          sudo cp /usr/lib/ISOLINUX/isolinux.bin iso/boot/isolinux/
          sudo cp /usr/lib/syslinux/modules/bios/* iso/boot/isolinux/

      - name: Build ISO
        run: |
          sudo xorriso -as mkisofs \
            -iso-level 3 \
            -o catbuntu.iso \
            -full-iso9660-filenames \
            -volid "CATBUNTU" \
            -eltorito-boot boot/isolinux/isolinux.bin \
            -boot-load-size 4 -boot-info-table \
            iso/

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: catbuntu-iso
          path: catbuntu.iso