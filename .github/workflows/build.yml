# .github/workflows/catbuntu.yml
name: Build Catbuntu From Scratch

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-from-scratch:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap \
          squashfs-tools \
          xorriso \
          grub-pc-bin \
          grub-efi-amd64-bin \
          mtools \
          dosfstools \
          linux-image-generic \
          git
          
    - name: Build minimal root filesystem
      run: |
        # Create minimal Ubuntu base
        sudo debootstrap --variant=minbase jammy ./catbuntu-root http://archive.ubuntu.com/ubuntu/
        
    - name: Install essential packages
      run: |
        sudo chroot ./catbuntu-root /bin/bash << 'EOL'
        # Mount proc for package management
        mount -t proc proc /proc
        
        # Install absolute minimum + our cat tools
        apt-get update
        apt-get install -y --no-install-recommends \
          linux-image-generic \
          systemd-sysv \
          sudo \
          network-manager \
          curl \
          wget \
          vim-tiny \
          git \
          fish \
          tmux \
          htop \
          neofetch \
          cmatrix \
          nyancat \
          oneko \
          sl \
          cowsay \
          fortune-mod \
          figlet \
          lolcat
        
        # Create user
        useradd -m -s /usr/bin/fish catuser
        echo "catuser:password" | chpasswd
        usermod -aG sudo catuser
        echo "catbuntu" > /etc/hostname
        
        # Set up auto-login on tty1
        mkdir -p /etc/systemd/system/getty@tty1.service.d/
        cat > /etc/systemd/system/getty@tty1.service.d/override.conf << 'EOF2'
        [Service]
        ExecStart=
        ExecStart=-/sbin/agetty --autologin catuser --noclear %I $TERM
        EOF2
        
        # Create welcome script
        cat > /home/catuser/.bashrc << 'EOF2'
        # Catbuntu Welcome
        if [ "$(tty)" = "/dev/tty1" ]; then
          clear
          echo "ðŸ± WELCOME TO CATBUNTU! ðŸ±" | lolcat
          echo "The purr-fect terminal-only distro!" | cowsay -f cat | lolcat
          echo ""
          echo "Try: neofetch, cmatrix, nyancat, oneko, sl"
          echo "Shell: fish (type 'fish' to start)"
          echo ""
          exec fish
        fi
        EOF2
        
        # Clean up
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        umount /proc
        EOL
        
    - name: Build initramfs and kernel setup
      run: |
        sudo chroot ./catbuntu-root /bin/bash << 'EOL'
        # Update initramfs
        update-initramfs -c -k $(ls /boot/vmlinuz-* | head -1 | sed 's|/boot/vmlinuz-||')
        EOL
        
    - name: Create bootable ISO structure
      run: |
        mkdir -p iso/boot/grub
        # Copy kernel and initramfs
        sudo cp catbuntu-root/boot/vmlinuz-* iso/boot/vmlinuz
        sudo cp catbuntu-root/boot/initrd.img-* iso/boot/initrd.img
        
        # Copy the entire system
        sudo cp -r catbuntu-root/* iso/ || true
        
        # Create GRUB config
        cat > iso/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        set default=0
        
        menuentry "Catbuntu From Scratch" {
            linux /boot/vmlinuz boot=live root=/dev/sr0 quiet splash
            initrd /boot/initrd.img
        }
        EOF
        
    - name: Create ISO
      run: |
        xorriso -as mkisofs \
          -iso-level 3 \
          -full-iso9660-filenames \
          -volid "CATBUNTU" \
          -eltorito-boot boot/grub/grub.cfg \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
          -output catbuntu-from-scratch.iso \
          iso/
          
    - name: Upload Catbuntu ISO
      uses: actions/upload-artifact@v4
      with:
        name: catbuntu-from-scratch
        path: catbuntu-from-scratch.iso
        retention-days: 3
        
    - name: Build success message
      run: |
        echo "ðŸŽ‰ CATBUNTU FROM SCRATCH BUILT!"
        echo "ðŸ¾ This is a REAL custom distro:"
        echo "  - Built from debootstrap (no base ISO)"
        echo "  - Custom kernel + initramfs"
        echo "  - Auto-login to fish shell"
        echo "  - Pure minimal system + cat toys"
        echo "ðŸ“¥ Download from Actions artifacts!"