# .github/workflows/catbuntu.yml
name: Build Catbuntu From Scratch

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-from-scratch:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debootstrap \
          squashfs-tools \
          xorriso \
          grub-pc-bin \
          grub-efi-amd64-bin \
          mtools \
          dosfstools \
          git
          
    - name: Build minimal root filesystem
      run: |
        # Create minimal Ubuntu base WITH kernel
        sudo debootstrap --include=linux-image-generic,initramfs-tools jammy ./catbuntu-root http://archive.ubuntu.com/ubuntu/
        
    - name: Setup system and install cat tools
      run: |
        sudo chroot ./catbuntu-root /bin/bash << 'EOL'
        # Mount necessary filesystems
        mount -t proc proc /proc
        mount -t sysfs sys /sys
        mount -t devtmpfs dev /dev
        
        # Install our cat packages
        apt-get update
        apt-get install -y --no-install-recommends \
          systemd-sysv \
          sudo \
          network-manager \
          curl \
          wget \
          vim-tiny \
          git \
          fish \
          tmux \
          htop \
          neofetch \
          cmatrix \
          nyancat \
          oneko \
          sl \
          cowsay \
          fortune-mod \
          figlet \
          lolcat
        
        # Create user
        useradd -m -s /usr/bin/fish catuser
        echo "catuser:password" | chpasswd
        usermod -aG sudo catuser
        echo "catbuntu" > /etc/hostname
        
        # Set up auto-login on tty1
        mkdir -p /etc/systemd/system/getty@tty1.service.d/
        cat > /etc/systemd/system/getty@tty1.service.d/override.conf << 'EOF2'
        [Service]
        ExecStart=
        ExecStart=-/sbin/agetty --autologin catuser --noclear %I $TERM
        EOF2
        
        # Create welcome script
        cat > /etc/profile.d/catbuntu-welcome.sh << 'EOF2'
        #!/bin/bash
        if [ "$(tty)" = "/dev/tty1" ]; then
          clear
          echo "ðŸ± WELCOME TO CATBUNTU! ðŸ±" | lolcat
          echo "The purr-fect terminal-only distro!" | cowsay -f cat | lolcat
          echo ""
          echo "Try: neofetch, cmatrix, nyancat, oneko, sl"
          echo "Shell: fish (type 'fish' to start)"
          echo ""
          exec fish
        fi
        EOF2
        chmod +x /etc/profile.d/catbuntu-welcome.sh
        
        # Update initramfs
        update-initramfs -u -k all
        
        # Clean up
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        
        # Unmount
        umount /proc
        umount /sys
        umount /dev
        EOL
        
    - name: Create bootable ISO structure
      run: |
        # Create ISO directory structure
        mkdir -p iso/boot/grub
        
        # Find and copy kernel files (with proper permissions)
        KERNEL_VERSION=$(sudo ls catbuntu-root/boot/vmlinuz-* | head -1 | xargs basename | sed 's/vmlinuz-//')
        echo "Using kernel: $KERNEL_VERSION"
        
        # Copy files with user ownership
        sudo cp catbuntu-root/boot/vmlinuz-$KERNEL_VERSION iso/boot/vmlinuz
        sudo cp catbuntu-root/boot/initrd.img-$KERNEL_VERSION iso/boot/initrd.img
        
        # Change ownership to current user
        sudo chown $USER:$USER iso/boot/vmlinuz
        sudo chown $USER:$USER iso/boot/initrd.img
        
        # Create GRUB config
        cat > iso/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        set default=0
        
        menuentry "Catbuntu From Scratch" {
            linux /boot/vmlinuz root=/dev/sr0 quiet splash
            initrd /boot/initrd.img
        }
        EOF
        
    - name: Create squashfs and ISO
      run: |
        # Create compressed filesystem (with user permissions)
        sudo mksquashfs catbuntu-root iso/filesystem.squashfs -comp xz
        sudo chown $USER:$USER iso/filesystem.squashfs
        
        # Create ISO with proper file access
        xorriso -as mkisofs \
          -iso-level 3 \
          -full-iso9660-filenames \
          -volid "CATBUNTU" \
          -eltorito-boot boot/grub/grub.cfg \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
          -output catbuntu-from-scratch.iso \
          iso/
          
    - name: Upload Catbuntu ISO
      uses: actions/upload-artifact@v4
      with:
        name: catbuntu-from-scratch
        path: catbuntu-from-scratch.iso
        retention-days: 3
        
    - name: Build success message
      run: |
        echo "ðŸŽ‰ CATBUNTU FROM SCRATCH BUILT!"
        echo "ðŸ“¦ Final ISO size: $(ls -lh catbuntu-from-scratch.iso | awk '{print $5}')"
        echo "ðŸ¾ Features:"
        echo "  - Built from debootstrap"
        echo "  - Custom kernel"
        echo "  - Auto-login to fish shell"
        echo "  - All cat-themed commands"
        echo "ðŸ“¥ Download from Actions artifacts!"
