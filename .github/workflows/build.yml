name: catbuntu

on:
  workflow_dispatch:

jobs:
  build_iso:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y xorriso isolinux syslinux-utils rsync debootstrap

      - name: Prepare root filesystem
        run: |
          mkdir -p rootfs
          # Use debootstrap for minimal Debian base
          sudo debootstrap --arch=amd64 bullseye rootfs http://deb.debian.org/debian

      - name: Prepare ISO structure
        run: |
          mkdir -p iso/{boot/isolinux,live}
          sudo rsync -a rootfs/ iso/live/
          # Copy isolinux bootloader
          sudo cp /usr/lib/ISOLINUX/isolinux.bin iso/boot/isolinux/
          sudo cp /usr/lib/syslinux/modules/bios/* iso/boot/isolinux/
          # Minimal isolinux.cfg
          echo "UI menu.c32
PROMPT 0
MENU TITLE Catbuntu
TIMEOUT 50
LABEL boot
  MENU LABEL Boot Catbuntu
  KERNEL /live/vmlinuz
  APPEND initrd=/live/initrd.img" | sudo tee iso/boot/isolinux/isolinux.cfg

      - name: Build ISO
        run: |
          sudo xorriso -as mkisofs \
            -iso-level 3 \
            -o catbuntu.iso \
            -full-iso9660-filenames \
            -volid "CATBUNTU" \
            -eltorito-boot boot/isolinux/isolinux.bin \
            -eltorito-catalog boot/isolinux/boot.cat \
            -no-emul-boot -boot-load-size 4 -boot-info-table \
            iso/

      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: catbuntu-iso
          path: catbuntu.iso