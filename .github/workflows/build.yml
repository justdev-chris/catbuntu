# .github/workflows/catbuntu.yml
name: Build Catbuntu Terminal ISO

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-minimal-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install ISO tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          genisoimage \
          squashfs-tools \
          xorriso \
          git \
          p7zip-full \
          wget \
          debootstrap
          
    - name: Build minimal Ubuntu base
      run: |
        # Create minimal Ubuntu filesystem
        sudo debootstrap jammy ./catbuntu-root http://archive.ubuntu.com/ubuntu/
        
        # Chroot and install terminal-only packages
        sudo chroot ./catbuntu-root /bin/bash << 'EOL'
        apt-get update
        apt-get install -y \
          linux-image-generic \
          systemd-sysv \
          sudo \
          network-manager \
          curl \
          wget \
          vim \
          git \
          fish \
          tmux \
          htop \
          neofetch \
          cmatrix \
          nyancat \
          oneko \
          sl \
          cowsay \
          fortune-mod \
          figlet \
          lolcat
          
        # Create user
        useradd -m -s /usr/bin/fish catuser
        echo "catuser:password" | chpasswd
        usermod -aG sudo catuser
        
        # Set hostname
        echo "catbuntu" > /etc/hostname
        
        # Install bootloader
        apt-get install -y grub-pc
        
        # Clean up
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        EOL
        
    - name: Create bootable ISO structure
      run: |
        mkdir -p iso/boot/grub
        cp -r catbuntu-root/boot/vmlinuz* iso/boot/
        cp -r catbuntu-root/boot/initrd* iso/boot/
        
        # Create GRUB config
        cat > iso/boot/grub/grub.cfg << 'EOF'
        set timeout=5
        set default=0
        
        menuentry "Catbuntu Terminal" {
            linux /boot/vmlinuz boot=live quiet splash
            initrd /boot/initrd.img
        }
        
        menuentry "Catbuntu Terminal (Safe Mode)" {
            linux /boot/vmlinuz boot=live quiet splash nomodeset
            initrd /boot/initrd.img
        }
        EOF
        
        # Copy the entire system
        sudo cp -r catbuntu-root/* iso/ || true
        
    - name: Create ISO
      run: |
        xorriso -as mkisofs \
          -iso-level 3 \
          -full-iso9660-filenames \
          -volid "CATBUNTU" \
          -eltorito-boot boot/grub/grub.cfg \
          -no-emul-boot -boot-load-size 4 -boot-info-table \
          -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
          -output catbuntu-terminal.iso \
          iso/
          
    - name: Create cute first-boot script
      run: |
        # This runs on first boot
        sudo mkdir -p catbuntu-root/etc/profile.d
        sudo cat > catbuntu-root/etc/profile.d/catbuntu-welcome.sh << 'EOF'
        #!/bin/bash
        if [ "$0" = "/bin/bash" ] || [ "$0" = "/bin/fish" ]; then
          echo "ðŸ± WELCOME TO CATBUNTU! ðŸ±" | lolcat
          echo "The purr-fect terminal-only distro!" | cowsay -f cat | lolcat
          echo ""
          echo "Try: neofetch, cmatrix, nyancat, oneko, sl"
          echo "Shell: fish (type 'fish' if in bash)"
          echo ""
        fi
        EOF
        sudo chmod +x catbuntu-root/etc/profile.d/catbuntu-welcome.sh
        
    - name: Upload Catbuntu ISO
      uses: actions/upload-artifact@v4
      with:
        name: catbuntu-terminal
        path: catbuntu-terminal.iso
        retention-days: 3
        
    - name: Show ISO info
      run: |
        echo "ðŸŽ‰ CATBUNTU TERMINAL ISO BUILT!"
        echo "ðŸ¾ Features:"
        echo "  - Minimal Ubuntu base"
        echo "  - Fish shell (default)"
        echo "  - Cat-themed fun commands"
        echo "  - Neofetch, cmatrix, nyancat, oneko"
        echo "  - Git, curl, vim pre-installed"
        echo "ðŸ“¥ Download from Actions artifacts!"
